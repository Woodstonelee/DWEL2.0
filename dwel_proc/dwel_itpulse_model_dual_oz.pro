pro DWEL_itpulse_model_dual_oz, wavelength, i_val, t_val, r_val, p_range, p_time, itpulse, t_fwhm, r_fwhm
  compile_opt idl2
  
  ;THis routine sets up the model for the iterated DWEL pulse.
  ;Pulses have been set as an empirical model as an array at the step corresponding to 0.5 nsec sampling.
  ;This model may be interpolated to fit any other step size and is controlled by the position and magnitude
  ;of the peak of the pulse - the T_zero point
  ;
  ;Some information:
  ;
  ; Peak occurs at zero range or time with a value of 1.0
  ; FWHM is the sum of pulse values
  ;
  ;INPUTS:
  ;
  ;     wavelength  wavelength of the laser of which the pulse model is needed
  ;     i_val     positions of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     t_val     time vale of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     r_val     range vale of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     p_range   the range ordinates of the model
  ;     p_time    the time ordinates of the model
  ;     pulse     values of the normalised pulse (peak value = 1.0)
  ;
  
  c=0.299792458
  c2=c/2.0
  
  ;; Oz DWEL July 2014
  if (wavelength eq 1064) then begin
    ; Mean pulse model
    p_time=[$
      -40.00,-39.50,-39.00,-38.50,-38.00,-37.50,-37.00,-36.50,-36.00,-35.50,$
      -35.00,-34.50,-34.00,-33.50,-33.00,-32.50,-32.00,-31.50,-31.00,-30.50,$
      -30.00,-29.50,-29.00,-28.50,-28.00,-27.50,-27.00,-26.50,-26.00,-25.50,$
      -25.00,-24.50,-24.00,-23.50,-23.00,-22.50,-22.00,-21.50,-21.00,-20.50,$
      -20.00,-19.50,-19.00,-18.50,-18.00,-17.50,-17.00,-16.50,-16.00,-15.50,$
      -15.00,-14.50,-14.00,-13.50,-13.00,-12.50,-12.00,-11.50,-11.00,-10.50,$
      -10.00,-9.50,-9.00,-8.50,-8.00,-7.50,-7.00,-6.50,-6.00,-5.50,$
      -5.00,-4.50,-4.00,-3.50,-3.00,-2.50,-2.00,-1.50,-1.00,-0.50,$
      0.00,0.50,1.00,1.50,2.00,2.50,3.00,3.50,4.00,4.50,$
      5.00,5.50,6.00,6.50,7.00,7.50,8.00,8.50,9.00,9.50,$
      10.00,10.50,11.00,11.50,12.00,12.50,13.00,13.50,14.00,14.50,$
      15.00,15.50,16.00,16.50,17.00,17.50,18.00,18.50,19.00,19.50,$
      20.00,20.50,21.00,21.50,22.00,22.50,23.00,23.50,24.00,24.50,$
      25.00,25.50,26.00,26.50,27.00,27.50,28.00,28.50,29.00,29.50,$
      30.00,30.50,31.00,31.50,32.00,32.50,33.00,33.50,34.00,34.50,$
      35.00,35.50,36.00,36.50,37.00,37.50,38.00,38.50,39.00,39.50,$
      40.00]
      
    itpulse=[$
      0.000000,0.000000,0.000000,0.000000,0.000000,0.000001,0.000002,0.000005,0.000011,0.000021,$
      0.000040,0.000071,0.000122,0.000199,0.000307,0.000451,0.000632,0.000849,0.001087,0.001333,$
      0.001565,0.001759,0.001890,0.001936,0.001881,0.001723,0.001468,0.001134,0.000757,0.000394,$
      0.000112,-0.000005,0.000135,0.000623,0.001516,0.002827,0.004499,0.006383,0.008236,0.009735,$
      0.010513,0.010207,0.008522,0.005298,0.000578,-0.005354,-0.011960,-0.018466,-0.023916,-0.027273,$
      -0.027543,-0.023927,-0.015952,-0.003618,0.012511,0.031253,0.050842,0.069010,0.083176,0.090697,$
      0.089214,0.077010,0.053416,0.019147,-0.023422,-0.070186,-0.115407,-0.152118,-0.172736,-0.169962,$
      -0.137768,-0.072463,0.026443,0.155616,0.307754,0.471990,0.634870,0.781782,0.898706,0.974005,$
      1.000000,0.974005,0.898706,0.781782,0.634870,0.471990,0.307754,0.155616,0.026443,-0.072463,$
      -0.137768,-0.169962,-0.172736,-0.152118,-0.115407,-0.070186,-0.023422,0.019147,0.053416,0.077010,$
      0.089214,0.090697,0.083176,0.069010,0.050842,0.031253,0.012511,-0.003618,-0.015952,-0.023927,$
      -0.027543,-0.027273,-0.023916,-0.018466,-0.011960,-0.005354,0.000578,0.005298,0.008522,0.010207,$
      0.010513,0.009735,0.008236,0.006383,0.004499,0.002827,0.001516,0.000623,0.000135,-0.000005,$
      0.000112,0.000394,0.000757,0.001134,0.001468,0.001723,0.001881,0.001936,0.001890,0.001759,$
      0.001565,0.001333,0.001087,0.000849,0.000632,0.000451,0.000307,0.000199,0.000122,0.000071,$
      0.000040,0.000021,0.000011,0.000005,0.000002,0.000001,0.000000,0.000000,0.000000,0.000000,$
      0.000000]
  endif
  if (wavelength eq 1548) then begin
    ; Mean pulse model
    p_time=[$
      -40.00,-39.50,-39.00,-38.50,-38.00,-37.50,-37.00,-36.50,-36.00,-35.50,$
      -35.00,-34.50,-34.00,-33.50,-33.00,-32.50,-32.00,-31.50,-31.00,-30.50,$
      -30.00,-29.50,-29.00,-28.50,-28.00,-27.50,-27.00,-26.50,-26.00,-25.50,$
      -25.00,-24.50,-24.00,-23.50,-23.00,-22.50,-22.00,-21.50,-21.00,-20.50,$
      -20.00,-19.50,-19.00,-18.50,-18.00,-17.50,-17.00,-16.50,-16.00,-15.50,$
      -15.00,-14.50,-14.00,-13.50,-13.00,-12.50,-12.00,-11.50,-11.00,-10.50,$
      -10.00,-9.50,-9.00,-8.50,-8.00,-7.50,-7.00,-6.50,-6.00,-5.50,$
      -5.00,-4.50,-4.00,-3.50,-3.00,-2.50,-2.00,-1.50,-1.00,-0.50,$
      0.00,0.50,1.00,1.50,2.00,2.50,3.00,3.50,4.00,4.50,$
      5.00,5.50,6.00,6.50,7.00,7.50,8.00,8.50,9.00,9.50,$
      10.00,10.50,11.00,11.50,12.00,12.50,13.00,13.50,14.00,14.50,$
      15.00,15.50,16.00,16.50,17.00,17.50,18.00,18.50,19.00,19.50,$
      20.00,20.50,21.00,21.50,22.00,22.50,23.00,23.50,24.00,24.50,$
      25.00,25.50,26.00,26.50,27.00,27.50,28.00,28.50,29.00,29.50,$
      30.00,30.50,31.00,31.50,32.00,32.50,33.00,33.50,34.00,34.50,$
      35.00,35.50,36.00,36.50,37.00,37.50,38.00,38.50,39.00,39.50,$
      40.00]
      
    itpulse=[$
      0.000000,0.000000,0.000000,0.000000,0.000000,0.000001,0.000002,0.000005,0.000011,0.000021,$
      0.000040,0.000071,0.000122,0.000199,0.000307,0.000451,0.000632,0.000849,0.001087,0.001333,$
      0.001565,0.001759,0.001890,0.001936,0.001881,0.001723,0.001468,0.001134,0.000757,0.000394,$
      0.000112,-0.000005,0.000135,0.000623,0.001516,0.002827,0.004499,0.006383,0.008236,0.009735,$
      0.010513,0.010207,0.008522,0.005298,0.000578,-0.005354,-0.011960,-0.018466,-0.023916,-0.027273,$
      -0.027543,-0.023927,-0.015952,-0.003618,0.012511,0.031253,0.050842,0.069010,0.083176,0.090697,$
      0.089214,0.077010,0.053416,0.019147,-0.023422,-0.070186,-0.115407,-0.152118,-0.172736,-0.169962,$
      -0.137768,-0.072463,0.026443,0.155616,0.307754,0.471990,0.634870,0.781782,0.898706,0.974005,$
      1.000000,0.974005,0.898706,0.781782,0.634870,0.471990,0.307754,0.155616,0.026443,-0.072463,$
      -0.137768,-0.169962,-0.172736,-0.152118,-0.115407,-0.070186,-0.023422,0.019147,0.053416,0.077010,$
      0.089214,0.090697,0.083176,0.069010,0.050842,0.031253,0.012511,-0.003618,-0.015952,-0.023927,$
      -0.027543,-0.027273,-0.023916,-0.018466,-0.011960,-0.005354,0.000578,0.005298,0.008522,0.010207,$
      0.010513,0.009735,0.008236,0.006383,0.004499,0.002827,0.001516,0.000623,0.000135,-0.000005,$
      0.000112,0.000394,0.000757,0.001134,0.001468,0.001723,0.001881,0.001936,0.001890,0.001759,$
      0.001565,0.001333,0.001087,0.000849,0.000632,0.000451,0.000307,0.000199,0.000122,0.000071,$
      0.000040,0.000021,0.000011,0.000005,0.000002,0.000001,0.000000,0.000000,0.000000,0.000000,$
      0.000000]
  endif
  
  p_range = p_time*c2
  fwhm=total(itpulse,/double)
  t_fwhm=fwhm*(p_time[1]-p_time[0])    ; nanosec
  r_fwhm=fwhm*(p_range[1]-p_range[0])  ; metres
  
  ;find where the left and right 0.0001*peak is
  tmp_I = where(itpulse ge 0.0001)
  tmp = max(itpulse, max_I)
  
  ;=====================================
  ; find the trough and secondary peak
  ; maximum peak location
  tmp = max(itpulse, maxpeakloc)
  maxpeakloc = maxpeakloc[0]
  ; find the three zero-cross points after the maximum peak
  wflen = size(itpulse, /n_elements)
  zero_xloc = where(itpulse[maxpeakloc:wflen-2]*itpulse[maxpeakloc+1:wflen-1] le 0, tmpcount) + maxpeakloc
  ; find the minimum and maximum between the first zero-cross point and the third zero-cross point
  tmp = min(itpulse[zero_xloc[0]:zero_xloc[2]], tmploc)
  troughloc = fix(mean(tmploc)) + zero_xloc[0]
  tmp = max(itpulse[zero_xloc[0]:zero_xloc[2]], tmploc)
  scdpeakloc = fix(mean(tmploc)) + zero_xloc[0]
  ;=====================================
  
  i_val=[0, tmp_I[0],  max_I, troughloc, scdpeakloc, tmp_I[n_elements(tmp_I)-1], n_elements(itpulse)-1]
  
  r_val=[p_range[i_val[0]],p_range[i_val[1]],p_range[i_val[2]], p_range[i_val[3]], p_range[i_val[4]], p_range[i_val[5]],p_range[i_val[6]]]
  t_val=r_val/c2
  
  print,'p_time check=',[p_time[i_val[0]],p_time[i_val[1]],p_time[i_val[2]],p_time[i_val[3]],p_time[i_val[4]],p_time[i_val[5]],p_time[i_val[6]]]
  print,'p_range check=',[p_range[i_val[0]],p_range[i_val[1]],p_range[i_val[2]],p_range[i_val[3]],p_range[i_val[4]],p_range[i_val[5]],p_range[i_val[6]]]
  print,'itpulse check=',[itpulse[i_val[0]],itpulse[i_val[1]],itpulse[i_val[2]],itpulse[i_val[3]],itpulse[i_val[4]],itpulse[i_val[5]],itpulse[i_val[6]]]
  print,'expected number=',strtrim(string(i_val[6]+1),2)+' actual number=',strtrim(string(n_elements(itpulse)),2)
  
  return
end

